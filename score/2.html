<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Scorecard</title>
  <link href="https://fonts.googleapis.com/css?family=Economica&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: 'Economica', sans-serif;
      font-size: 22px;
      margin: 0 auto;
      max-width: 1200px;
      background: linear-gradient(135deg, #f0f2f5 0%, #ffffff 100%) no-repeat;
      min-height: 100vh;
      background-size: cover;
      overflow: hidden;
      touch-action: none;
    }

    h1 {
      text-align: center;
    }

    table {
      width: 100%;
      table-layout: fixed;
      border-collapse: collapse;
      font-size: 20px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      overflow: hidden;
    }

    table th, table td {
      border: none;
      text-align: center;
      padding: 5px;
      word-wrap: break-word;
      cursor: pointer;
      border-bottom: 1px solid rgba(200, 200, 200, 0.3);
    }

    table th {
      background: linear-gradient(to bottom, #333333 0%, #4d4d4d 100%);
      color: white;
    }

    table th:first-child, table td:first-child {
      font-weight: bold;
      width: 30px;
      min-width: 30px;
      max-width: 30px;
      overflow: hidden;
      color: white;
      border-bottom: 1px solid #666;
    }

    table td:first-child {
      background: #4d4d4d;
    }

    #scoreTable thead th {
      height: 75px;
      font-size: 22px;
    }

    #scoreTable thead th span.score {
      font-size: 22px;
    }

    #scoreTable thead th small {
      font-size: 16px;
      color: rgba(255, 255, 255, 0.8);
    }

    table input {
      width: 100%;
      box-sizing: border-box;
      padding: 8px;
      text-align: center;
      font-size: inherit;
      border: 1px solid #d0d7de;
      border-radius: 6px;
      background: #ffffff;
      box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.05);
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    table input:focus {
      outline: none;
      border-color: #333333;
      box-shadow: 0 0 5px rgba(51, 51, 51, 0.5);
    }

    table input::placeholder {
      font-size: 16px;
      text-align: center;
      line-height: 16px;
      color: #6b7280;
      opacity: 0.8;
    }

    .highlight-winner {
      background: linear-gradient(to bottom, #34c759 0%, #28a745 100%);
    }

    .highlight-loser {
      background: linear-gradient(to bottom, #e63946 0%, #c62835 100%);
    }

    table input[type="number"]::-webkit-outer-spin-button,
    table input[type="number"]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    table input[type="number"] {
      -moz-appearance: textfield;
      appearance: textfield;
    }

    #scoreBody tr:not(:last-child) td:not(:first-child) {
      max-height: 5px;
      height: 5px;
      line-height: 5px;
      overflow: hidden;
    }

    #scoreBody tr:last-child td input {
      font-size: 16px;
    }

    .popup-modal {
      display: none;
      position: fixed;
      left: 50%;
      background: #ffffff;
      padding: 5px 20px 20px;
      z-index: 1000;
      width: 200px;
      max-width: 90%;
      text-align: center;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      border-radius: 10px;
    }

    #playerManagementModal {
      top: 15%;
      transform: translate(-50%, -15%);
    }

    #roundManagementModal {
      top: 50%;
      transform: translate(-50%, -50%);
    }

    .popup-modal input[type="text"],
    .popup-modal select {
      font-size: 24px;
      padding: 10px;
      margin: 5px 0;
      border: 1px solid #ddd;
      border-radius: 6px;
      background: #f8f9fa;
    }

    .popup-modal input[type="text"] {
      width: 100%;
      box-sizing: border-box;
      text-align: center;
    }

    .popup-modal input[type="text"]:focus {
      outline: none;
      border-color: #333333;
    }

    .popup-modal button {
      font-size: 24px;
      padding: 10px 20px;
      margin: 5px;
      cursor: pointer;
      background: linear-gradient(to bottom, #333333 0%, #4d4d4d 100%);
      color: white;
      border: none;
      border-radius: 6px;
      transition: background 0.2s;
    }

    #overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.3);
      z-index: 999;
      cursor: pointer;
    }

    * {
      -webkit-tap-highlight-color: transparent;
    }

    .scaled-emoji {
      transform: scale(.75);
      transform-origin: center;
      display: inline-block;
    }

    @media (max-width: 480px) {
      #scoreTable.small-scores thead th {
        padding: 3px;
      }
      #scoreTable.small-scores thead th span.score {
        font-size: 18px;
        line-height: 1.2;
      }
      #scoreTable.small-scores thead th small {
        font-size: 12px;
      }
      #scoreTable.small-scores tbody td {
        font-size: 16px;
      }
      #scoreTable.small-scores tbody tr:last-child input[type="number"] {
        font-size: 14px;
        padding: 5px;
        height: 32px;
      }
      #scoreTable.small-scores tbody tr:last-child input[type="number"]::placeholder {
        font-size: 14px;
        line-height: 10px;
      }
    }
  </style>
</head>
<body>
  <table id="scoreTable">
    <thead>
      <tr id="playerRow">
        <th>#</th>
      </tr>
    </thead>
    <tbody id="scoreBody"></tbody>
  </table>

  <div id="playerManagementModal" class="popup-modal"></div>
  <div id="roundManagementModal" class="popup-modal"></div>
  <div id="overlay"></div>

  <script>
    let players = JSON.parse(localStorage.getItem('players')) || 
      Array(4).fill().map((_, i) => ({ name: `P${i+1}`.toUpperCase(), totalScore: 0, roundScores: [] }));
    let rounds = JSON.parse(localStorage.getItem('rounds')) || [];
    let scoringMode = localStorage.getItem('scoringMode') || 'lowest';
    if (!localStorage.getItem('initialized')) {
      localStorage.setItem('initialized', 'true');
      saveData();
    }

    function saveData() {
      localStorage.setItem('players', JSON.stringify(players));
      localStorage.setItem('rounds', JSON.stringify(rounds));
      localStorage.setItem('scoringMode', scoringMode);
    }

    function addRoundScores() {
      const inputs = document.querySelectorAll("#scoreTable input[type='number']");
      const scores = Array.from(inputs).map(input => parseInt(input.value) || 0);
      rounds.push(scores);
      players.forEach((player, i) => {
        player.roundScores.push(scores[i]);
        player.totalScore = player.roundScores.reduce((a, b) => a + b, 0);
      });
      saveData();
      updateUI();
      inputs.forEach(input => input.value = '');
    }

    function updateUI() {
      const playerRow = document.getElementById("playerRow");
      const scoreTable = document.getElementById("scoreTable");
      scoreTable.classList.toggle("small-scores", players.length >= 7);

      playerRow.innerHTML = `<th onclick="event.stopPropagation(); createRoundManagementDialog()">â˜°</th>` +
        players.map((player, i) => `
          <th onclick="handlePlayerNameClick(event, ${i})" title="Manage ${player.name}">
            ${player.name}<br>
            <span class="score">${player.totalScore || rounds.length ? player.totalScore : ''}</span>
            ${rounds.length ? `<br><small>${getRank(player.totalScore)}</small>` : ''}
          </th>
        `).join('');

      const scoreBody = document.getElementById("scoreBody");
      scoreBody.innerHTML = rounds.map((round, i) => `
        <tr>
          <td onclick="confirmDeleteRound(${i})">${i + 1}</td>
          ${players.map((_, j) => `
            <td contenteditable="true" inputmode="numeric" onclick="selectText(this)" onblur="updateScore(${i}, ${j}, this.innerText)">
              ${round[j] === 0 ? '<span class="scaled-emoji">ðŸ”¥</span>' : round[j] || '<span class="scaled-emoji">ðŸ”¥</span>'}
            </td>
          `).join('')}
        </tr>
      `).join('') + `
        <tr>
          <td onclick="addRoundScores()">ï¼‹</td>
          ${players.map(player => `<td><input type="number" placeholder="${player.name}" inputmode="numeric" /></td>`).join('')}
        </tr>
      `;

      if (rounds.length) updateRankings();

      document.querySelectorAll("#scoreTable input[type='number']").forEach((input, i, inputs) => {
        input.onkeydown = e => {
          if (e.key !== 'Enter') return;
          e.preventDefault();
          const allFilled = allInputsFilled(inputs);
          allFilled ? (addRoundScores(), inputs[0].focus()) :
            i < inputs.length - 1 ? inputs[i + 1].focus() :
            inputs[Array.from(inputs).findIndex(inp => !inp.value.trim())]?.focus() || inputs[0].focus();
        };
      });
    }

    function getRank(score) {
      if (players.length === 1) return "1st";
      const sorted = [...players].sort((a, b) => scoringMode === "highest" ? b.totalScore - a.totalScore : a.totalScore - b.totalScore);
      const rank = sorted.findIndex(p => p.totalScore === score) + 1;
      return rank + (rank % 10 === 1 && rank % 100 !== 11 ? "st" : rank % 10 === 2 && rank % 100 !== 12 ? "nd" : rank % 10 === 3 && rank % 100 !== 13 ? "rd" : "th");
    }

    function updateScore(roundIndex, playerIndex, newScore) {
      const score = parseInt(newScore) || 0;
      rounds[roundIndex][playerIndex] = score;
      players[playerIndex].roundScores[roundIndex] = score;
      players[playerIndex].totalScore = players[playerIndex].roundScores.reduce((a, b) => a + b, 0);
      saveData();
      updateUI();
    }

    function updateRankings() {
      if (!rounds.length || players.length === 1) return;
      const sorted = [...players].sort((a, b) => scoringMode === "highest" ? b.totalScore - a.totalScore : a.totalScore - b.totalScore);
      const ths = Array.from(document.getElementById("playerRow").children).slice(1);
      const [winScore, loseScore] = [sorted[0].totalScore, sorted[sorted.length - 1].totalScore];
      const allSame = players.every(p => p.totalScore === winScore);
      ths.forEach(th => th.classList.remove("highlight-winner", "highlight-loser"));
      players.forEach((p, i) => ths[i].classList.add(allSame || p.totalScore === winScore ? "highlight-winner" : p.totalScore === loseScore ? "highlight-loser" : ""));
    }

    function createPlayerManagementDialog(index) {
      const modal = document.getElementById('playerManagementModal');
      modal.innerHTML = `
        <h2>Manage ${players[index].name}</h2>
        <input type="text" id="playerNameInput" value="${players[index].name}" autocapitalize="characters" inputmode="text" style="text-transform: uppercase;">
        <button onclick="updatePlayerName(${index})">Update</button>
        <button onclick="confirmRemovePlayer(${index})">Remove Player</button>
        <button onclick="closePopup('playerManagementModal')">Close</button>
      `;
      modal.style.display = 'block';
      toggleOverlay(true);
      const input = modal.querySelector('#playerNameInput');
      input.focus();
      input.select();
      input.onkeypress = e => e.key === 'Enter' && (updatePlayerName(index), closePopup('playerManagementModal'));
      input.oninput = () => input.value = input.value.toUpperCase();
    }

    function updatePlayerName(index) {
      const newName = document.getElementById('playerNameInput').value.trim().toUpperCase();
      if (newName && newName !== players[index].name) {
        players[index].name = newName;
        saveData();
        updateUI();
      }
      closePopup('playerManagementModal');
    }

    function confirmRemovePlayer(index) {
      if (confirm(`Are you sure you want to remove ${players[index].name}?`)) {
        players.splice(index, 1);
        rounds.forEach(r => r.splice(index, 1));
        saveData();
        updateUI();
      }
    }

    function handlePlayerNameClick(event, index) {
      event.stopPropagation();
      closeAllPopups();
      createPlayerManagementDialog(index);
    }

    function createRoundManagementDialog() {
      const modal = document.getElementById('roundManagementModal');
      modal.innerHTML = `
        <h2>Round Management</h2>
        <select id="playerCount" onchange="updatePlayerCount()">
          ${Array(8).fill().map((_, i) => `<option value="${i+1}" ${players.length === i+1 ? 'selected' : ''}>${i+1} Players</option>`).join('')}
        </select>
        <button onclick="toggleScoringMode(); updateUI(); closePopup('roundManagementModal')">Toggle ${scoringMode === 'highest' ? 'High' : 'Low'}</button>
        <button onclick="resetScores()">Reset</button>
        <button onclick="closePopup('roundManagementModal')">Close</button>
      `;
      modal.style.display = 'block';
      toggleOverlay(true);
    }

    function updatePlayerCount() {
      const newCount = parseInt(document.getElementById('playerCount').value);
      if (newCount > players.length) {
        players.push(...Array(newCount - players.length).fill().map((_, i) => ({
          name: `P${players.length + i + 1}`.toUpperCase(),
          totalScore: 0,
          roundScores: Array(rounds.length).fill(0)
        })));
        rounds.forEach(r => r.push(...Array(newCount - r.length).fill(0)));
      } else if (newCount < players.length) {
        players.length = newCount;
        rounds.forEach(r => r.length = newCount);
      }
      saveData();
      updateUI();
      closePopup('roundManagementModal');
    }

    function toggleScoringMode() {
      scoringMode = scoringMode === "highest" ? "lowest" : "highest";
      saveData();
    }

    function resetScores() {
      if (confirm("Are you sure you want to reset all scores?")) {
        players.forEach(p => { p.roundScores = []; p.totalScore = 0; });
        rounds = [];
        saveData();
        updateUI();
        closePopup('roundManagementModal');
      }
    }

    function confirmDeleteRound(roundIndex) {
      if (confirm("Are you sure you want to delete this round?")) {
        rounds.splice(roundIndex, 1);
        players.forEach(p => {
          p.roundScores.splice(roundIndex, 1);
          p.totalScore = p.roundScores.reduce((a, b) => a + b, 0);
        });
        saveData();
        updateUI();
      }
    }

    function allInputsFilled(inputs) {
      return Array.from(inputs).every(input => input.value.trim());
    }

    function selectText(element) {
      const range = document.createRange();
      range.selectNodeContents(element);
      window.getSelection().removeAllRanges().addRange(range);
    }

    function toggleOverlay(show) {
      document.getElementById('overlay').style.display = show ? 'block' : 'none';
    }

    function closePopup(modalId) {
      document.getElementById(modalId).style.display = 'none';
      toggleOverlay(false);
    }

    function closeAllPopups() {
      ['playerManagementModal', 'roundManagementModal'].forEach(id => document.getElementById(id).style.display = 'none');
      toggleOverlay(false);
    }

    document.getElementById('overlay').onclick = closeAllPopups;

    updateUI();
  </script>
</body>
</html>